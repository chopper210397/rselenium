# df1<-data2 %>% select(Artículo)
df2<-maestrolansier %>% select(METRONIC,`artdsc VALID`,TIPO,equipo)
# con esto quito los espacios adelante y detrás del artdesvalid Y LOS ARTICULOS
# df1$Artículo<-trimws(df1$Artículo,"b")
# df2$Artículo<-trimws(df2$Artículo,"b")
# df2$artdesvalidvalid<-trimws(df2$artdesvalidvalid,"b")
# cambio el nombre a df2 para que coincida el nombre de la columna articulo para poder hacer el merge
colnames(df2)<-c("Artículo","artdesvalid","tipo","equipo")
# # probando el mismo proceso pero directamente para data 2 y ya no para df1
data2$Artículo<-trimws(data2$Artículo,"b")
data2$Artículo<-trimws(data2$Artículo,"b")
df2$artdesvalid<-trimws(df2$artdesvalid,"b")
# cruzando para obtener los validados, tipo y equipo
# probando si hay productos diferentes
productosnuevosmetronic<-data2[!data2$Artículo %in% df2$Artículo,]
write_xlsx(productosnuevosmetronic,"productosnuevosmetronic.xlsx")
data <- readWorksheetFromFile(paste0("C:\\Users\\LBarrios\\Downloads\\FacMet_",
year(today()),
ifelse(month(today())<10,paste0("0",month(today())),month(today())) ,
ifelse(day(today())<10,paste0("0",day(today())),day(today())),".xls"),
sheet = "FacturacionMetronic",
startRow = 6,
startCol = 1)
# retirando las columnas que eran merge de las otras
data<-data %>% select(-Col6,-Col12)
# seleccionando data para CIERRE DE MES ANTERIOR
# data<-data %>% filter(Periodo==paste0(year(today()),
#                                       ifelse(month(today())<10,paste0("0",month(today())-1),month(today()))))
# seleccionando data del periodo ACTUAL
data<-data %>% filter(Periodo==paste0(year(today()),
ifelse(month(today())<10,paste0("0",month(today())),month(today()))))
paste0(year(today()),
ifelse(month(today())<10,paste0("0",month(today())),month(today())))
data <- readWorksheetFromFile(paste0("C:\\Users\\LBarrios\\Downloads\\FacMet_",
year(today()),
ifelse(month(today())<10,paste0("0",month(today())),month(today())) ,
ifelse(day(today())<10,paste0("0",day(today())),day(today())),".xls"),
sheet = "FacturacionMetronic",
startRow = 6,
startCol = 1)
# retirando las columnas que eran merge de las otras
data<-data %>% select(-Col6,-Col12)
# seleccionando data para CIERRE DE MES ANTERIOR
# data<-data %>% filter(Periodo==paste0(year(today()),
#                                       ifelse(month(today())<10,paste0("0",month(today())-1),month(today()))))
# seleccionando data del periodo ACTUAL
data<-data %>% filter(Periodo==paste0(year(today()),
ifelse(month(today())<10,paste0("0",month(today())),month(today()))))
# borrando los valores de articulo iguales a productos covid
data<-data %>% filter(!(Artículo %in%
c("VESOGVT001","VESOGVT002","VESOTR001","VESOTR002","VESOTR003","VESOTR004","VEDMLN001")))
# borrando de columna Vendedor = OFICINA
data<-data %>% filter(!(Vendedor %in% c("OFICINA")))
# creando columna fuente que diga METRONIC
data<-data %>% mutate(FUENTE="METRONIC")
# creando columna periodo con el primer dia del mes a actualizar
data<-data %>% mutate(periodo=paste0("01/",
ifelse(month(today())<10,paste0("0",month(today())),month(today())),
"/",year(today())))
# insertando columna ELIMINAR en vacio
data<-data %>% mutate(ELIMINAR="")
# creando columna DSCZONA
data<-data %>% mutate(DSCZONA="")
# creando ppuni ppsol flag dpto dist prov que estaran vacias
data<-data %>% mutate(ppuni="") %>% mutate(ppsol="") %>% mutate(flag="") %>% mutate(dpto="") %>% mutate(dist="") %>% mutate(prov="")
# seleccionando solo las columnas que nos interesan
# DATA2 TIENE EL FORMATO QUE SE CARGARIA AL SQL
data2<-data %>%
select(FUENTE,periodo,Nro.Doc,Fecha,Ruc,ELIMINAR,Cliente,Condición,Artículo,Cant,Subtotal,DSCZONA,Zona,Vendedor,ppuni,ppsol,flag,dpto,dist,prov)
# con esto leo el maestro lansier con el cual cruzare mi data
maestrolansier <- read_xlsx("maestrolansier.xlsx")
# aqui selecciono lo que voy a cruzar
# df1<-data2 %>% select(Artículo)
df2<-maestrolansier %>% select(METRONIC,`artdsc VALID`,TIPO,equipo)
# con esto quito los espacios adelante y detrás del artdesvalid Y LOS ARTICULOS
# df1$Artículo<-trimws(df1$Artículo,"b")
# df2$Artículo<-trimws(df2$Artículo,"b")
# df2$artdesvalidvalid<-trimws(df2$artdesvalidvalid,"b")
# cambio el nombre a df2 para que coincida el nombre de la columna articulo para poder hacer el merge
colnames(df2)<-c("Artículo","artdesvalid","tipo","equipo")
# # probando el mismo proceso pero directamente para data 2 y ya no para df1
data2$Artículo<-trimws(data2$Artículo,"b")
data2$Artículo<-trimws(data2$Artículo,"b")
df2$artdesvalid<-trimws(df2$artdesvalid,"b")
# cruzando para obtener los validados, tipo y equipo
# probando si hay productos diferentes
productosnuevosmetronic<-data2[!data2$Artículo %in% df2$Artículo,]
write_xlsx(productosnuevosmetronic,"productosnuevosmetronic.xlsx")
#
ArtdesValid2<-merge(x = data2, y = df2, by.x = "Artículo", all.x = TRUE)
data3<-ArtdesValid2 %>%
select(FUENTE,periodo,Nro.Doc,Fecha,Ruc,ELIMINAR,Cliente,Condición,Artículo,artdesvalid,Cant,Subtotal,DSCZONA,Zona,Vendedor,tipo,equipo,ppuni,ppsol,flag,dpto,dist,prov)
# creando el excel con la data ya formateada
# es fundamental utilizar la funcion write_xlsx ya que esta nos permite sobre escribir el excel sin tener que borrarlo previamente
write_xlsx(data3,"metronic.xlsx")
library(dplyr)
library(readxl)
library(lubridate)
library(writexl)
# LISTO TERMINADO
#------------------------------------------------------------------------------------------------------
#---------------------------------------------------------------------------------------------#
# ------------ con trimws puedo quitar los espacios iniciales y finales de un texto --------- #
#---------------------------------------------------------------------------------------------#
# x<- "  texto con espacios "
# trimws(x,"b")
# x<-c(" asds ", " asdasdas","sdasdas ","    asdasd  asd   asd    ","  asdsa  2  ")
# trimws(x,"b")
rm(list = ls())
library(dplyr)
library(readxl)
library(lubridate)
library(writexl)
paste0("C:\\Users\\LBarrios\\Downloads\\LANSIER-",
year(today()),
"-",
ifelse(month(today())==12,"DICIEMBRE","ENERO"),
".xlsx" )
paste0("C:\\Users\\LBarrios\\Downloads\\LANSIER-",
year(today()),
"-",
ifelse(month(today())==12,"DICIEMBRE",ifelse(month(today())==1,"ENERO"),"FEBRERO"),
".xlsx" )
paste0("C:\\Users\\LBarrios\\Downloads\\LANSIER-",
year(today()),
"-",
ifelse(month(today())==12,"DICIEMBRE",ifelse(month(today())==1,"ENERO","FEBRERO")),
".xlsx" )
paste0("C:\\Users\\LBarrios\\Downloads\\LANSIER-",
year(today()),
"-",
ifelse(month(today())==12,"DICIEMBRE",
ifelse(month(today())==1,"ENERO",
ifelse(month(today())==2,"FEBRERO","MARZO"))),
".xlsx" )
paste0("C:\\Users\\LBarrios\\Downloads\\LANSIER-",
year(today()),
"-",
ifelse(month(today())==12,"DICIEMBRE",
ifelse(month(today())==1,"ENERO",
ifelse(month(today())==2,"FEBRERO",
ifelse(month(today())==3,"MARZO",
ifelse(month(today())==4,"ABRIL",
ifelse(month(today())==5,"MAYO",
ifelse(month(today())==6,"JUNIO",
ifelse(month(today())==7,"JULIO",
ifelse(month(today())==8,"AGOSTO",
ifelse(month(today())==9,"SETIEMBRE",
ifelse(month(today())==10,"OCTUBRE","NOVIEMBRE"))))))))))),
".xlsx" )
data<-read_xlsx(path = paste0("C:\\Users\\LBarrios\\Downloads\\LANSIER-",
year(today()),
"-",
ifelse(month(today())==12,"DICIEMBRE",
ifelse(month(today())==1,"ENERO",
ifelse(month(today())==2,"FEBRERO",
ifelse(month(today())==3,"MARZO",
ifelse(month(today())==4,"ABRIL",
ifelse(month(today())==5,"MAYO",
ifelse(month(today())==6,"JUNIO",
ifelse(month(today())==7,"JULIO",
ifelse(month(today())==8,"AGOSTO",
ifelse(month(today())==9,"SETIEMBRE",
ifelse(month(today())==10,"OCTUBRE","NOVIEMBRE"))))))))))),
".xlsx" ))
# creando columna fuente que diga M&M
data<-data %>% mutate(FUENTE="M&M")
# creando columna periodo con el primer dia del mes a actualizar
data<-data %>% mutate(periodo=paste0("01/",
ifelse(month(today())<10,paste0("0",month(today())),month(today())),
"/",
year(today())))
# insertando columna ELIMINAR en vacio
data<-data %>% mutate(ELIMINAR="")
# creando columna DSCZONA
data<-data %>% mutate(DSCZONA="")
# creando ppuni ppsol flag dpto dist prov que estaran vacias
data<-data %>% mutate(ppuni="") %>%
mutate(ppsol="") %>% mutate(flag="") %>% mutate(dpto="") %>% mutate(dist="") %>% mutate(prov="")
# DATA2 TIENE EL FORMATO QUE SE CARGARIA AL SQL
data2<-data %>%
select(FUENTE,
periodo,NUMERO,
FECHA,RUC,ELIMINAR,
`NOMBRE CLIENTE`,DOCUMENTO,DESCRIPCION,CANTIDAD,
SUBTOT,DSCZONA,VENDEDOR,ppuni,ppsol,flag,DEPARTAMENTO,LOCALIDAD,PROVINCIA)
# trayendo el excel con todas las localidades para mym con lo cual se cruzará todo
# con esto leo el maestro lansier con el cual cruzare mi data
maestrolansier <- read_xlsx("maestrolansier.xlsx")
localidadesmym <- read_xlsx("localidadesmym.xlsx")
localidadesmym<-localidadesmym %>% select(LOCALIDAD,ZONA)
# PRIMERO CRUZAMOS CONTRA EL MAESTRO LANSIER
# aqui selecciono lo que voy a cruzar
# df1<-data2 %>% select(Artículo)
df2<-maestrolansier %>% select(`M&M`,`artdsc VALID`,TIPO,equipo)
# cambio el nombre a df2 para que coincida el nombre de la columna articulo para poder hacer el merge
colnames(df2)<-c("DESCRIPCION","artdesvalid","tipo","equipo")
# con esto quito los espacios adelante y detrás del artdesvalid Y LOS ARTICULOS
data2$DESCRIPCION<-trimws(data2$DESCRIPCION,"b")
df2$DESCRIPCION<-trimws(df2$DESCRIPCION,"b")
df2$artdesvalid<-trimws(df2$artdesvalid,"b")
# validando productos
productosnuevosmym<-data2[!data2$DESCRIPCION %in% df2$DESCRIPCION,]
write_xlsx(productosnuevosmym,"productosnuevosmym.xlsx")
# ----------------------------------------------------- #
# ---CRUCE DE INFORMACIÓN PARA OBTENER LOS VALIDADOS--- #
# ----------------------------------------------------- #
# cruzando para obtener los validados, tipo y equipo
ArtdesValid2<-merge(x = data2, y = df2, by.x = "DESCRIPCION", all.x = TRUE)
# validando que esten las mismas localidades
localidadesnuevasmym<-ArtdesValid2[!ArtdesValid2$LOCALIDAD %in% localidadesmym$LOCALIDAD,]
write_xlsx(localidadesnuevasmym,"localidadesnuevasmym.xlsx")
#
# CRUZANDO PARA OBTENER LA LOCALIDAD
ArtdesValid3<-merge(x = ArtdesValid2, y=localidadesmym, by.x = "LOCALIDAD", all.x = TRUE)
ArtdesValid3<-ArtdesValid3 %>%
select(FUENTE,periodo,NUMERO,FECHA,RUC,ELIMINAR,`NOMBRE CLIENTE`,DOCUMENTO,DESCRIPCION,artdesvalid,CANTIDAD,
SUBTOT,DSCZONA,ZONA,VENDEDOR,tipo,equipo,ppuni,ppsol,flag,DEPARTAMENTO,LOCALIDAD,PROVINCIA)
write_xlsx(ArtdesValid3,"mym.xlsx")
# en esta ocasion todo ha cruzado asi que esta bien
# este codigo de abajo es para ver si todas las localidades son las mismas
# a<-subset(data, !(LOCALIDAD %in% localidadesmym$LOCALIDAD))
rm(list = ls())
library(readxl)
library(dplyr)
library(lubridate)
library(readr)
library(RODBC)
library(qdapTools)
library(plyr)
library(lookup)
library(XLConnect)
# con esta leemos la data de hoy
data<-read_xls(paste0("C:\\Users\\LBarrios\\Downloads\\AVANCE DE VENTAS LANSIER ",
day(today()),".",
ifelse(month(today())<10,paste0("0",month(today())),month(today())),
".22.xls"), sheet = "DATA",skip = 4)
# con esto leemos la data de una fecha en específico dado que si no tenemos la data de hoy pero
# queremos cargar la data que nos pasaron de otro día copiamos el nombre del archivo en vez de lo nuestro
# data<-read_xls("C:\\Users\\LBarrios\\Downloads\\1. CIERRE DE VENTAS LANSIER - ENERO 2022.xls", sheet = "DATA",skip = 4)
# PARA FECHA DISTINTA A LA DE HOY
data<-read_xls("C:\\Users\\LBarrios\\Downloads\\AVANCE DE VENTAS LANSIER 05.02.22.xls", sheet = "DATA",skip = 4)
# eliminado la fila de totales ya que es la última fila siempre la eliminamos
totalrow<-nrow(data)
# totalrow<-which(data$VALOR=="203541.4974")
data<-data[-totalrow,]
# cambiando formato de la fecha
data$FECHA<-paste0(ifelse(day(data$FECHA)<10,paste0(0,day(data$FECHA)),day(data$FECHA)),
"-",
ifelse(month(data$FECHA)<10,paste0(0,month(data$FECHA)),month(data$FECHA))  ,
"-",
year(data$FECHA))
# creando columna fuente que diga METRONIC
data<-data %>% mutate(FUENTE="DIFARLIB")
# creando columna periodo con el primer dia del mes a actualizar
data<-data %>% mutate(periodo=paste0("01/",
ifelse(month(today())<10,paste0("0",month(today())),month(today())),
"/",
year(today())))
# insertando columna ELIMINAR en vacio
data<-data %>% mutate(ELIMINAR="")
# creando columna DSCZONA
data<-data %>% mutate(DSCVEND="")
# creando ppuni ppsol flag dpto dist prov que estaran vacias
data<-data %>% mutate(ppuni="") %>% mutate(ppsol="") %>% mutate(flag="")
# UNIENDO PRODUCTO Y PRESENTACION PARA HACER ARTDES
data$ARTDES<-paste0(data$PRODUCTO," ",data$PRESENTACION)
# seleccionando solo las columnas que nos interesan
# DATA2 TIENE EL FORMATO QUE SE CARGARIA AL SQL
# AQUI NO ESTOY PONIENDO ZONA NI DSCVEND NI TIPO NI EQUIPO
# NI ARTDESVALID PORQUE ESOS SERAN LOS QUE TRAERÉ CON EL MERGE
data2<-data %>%
select(FUENTE,periodo,NUMERO,FECHA,`RUC/DNI`,ELIMINAR,
`NOMBRE COMERCIAL`,TIPO,ARTDES,
CANT.,VALOR,DSCVEND,VENDEDOR,ppuni,ppsol,flag,DEPARTAMENTO,DISTRITO...24,PROVINCIA...23)
# LEYENDO DATA NECESARIA PARA VALIDAR
maestrolansier <- read_xlsx("maestrolansier.xlsx")
# selecciono solo lo que voy a querer de maestro lansier que para este caso seria DIMEXA artdesvalid tipo y equipo
df2<-maestrolansier %>% select(DIFARLIB,`artdsc VALID`,TIPO,equipo)
# cambio el nombre a df2 para que coincida el nombre de la columna articulo para poder hacer el merge
colnames(df2)<-c("ARTDES","artdesvalid","tipo","equipo")
# CON ESTO QUITO LOS ESPACIOS AL COMIENZO Y EL FINAL DE LOS ARTICULOS PORQUE NO PERMITIAN CRUZAR TODO
data2$ARTDES<-trimws(data2$ARTDES,"b")
df2$ARTDES<-trimws(df2$ARTDES,"b")
df2$artdesvalid<-trimws(df2$artdesvalid,"b")
# PRODUCTOS NUEVOS ARTDESVALID
productosnuevosdifarlib<-data2[!data2$ARTDES %in% df2$ARTDES,]
write_xlsx(productosnuevosdifarlib,"productosnuevosdifarlib.xlsx")
# TRAYENDO ARTDESVALID TIPO Y EQUIPO
data_maestro<-merge(x = data2, y = df2, by.x = "ARTDES", all.x = FALSE)
# creando la combinacion
data_maestro<-data_maestro %>% mutate(COMBINACION=paste0(PROVINCIA...23,DISTRITO...24))
# TRAER DATA LOCALIDADES DIFARLIB
localidadesdifarlib <- read_xlsx("localidadesdifarlib.xlsx")
localidadesdifarlib<-localidadesdifarlib %>% select(COMBINACION,ZONA)
localidadesdifarlib$COMBINACION<-trimws(localidadesdifarlib$COMBINACION,"b")
localidadesdifarlib$ZONA<-trimws(localidadesdifarlib$ZONA,"b")
data_maestro$COMBINACION<-trimws(data_maestro$COMBINACION,"b")
# VALIDANDO ZONAS NUEVAS
localidadesnuevasdifarlib<-data_maestro[!data_maestro$COMBINACION %in% localidadesdifarlib$COMBINACION,]
write_xlsx(localidadesnuevasdifarlib,"localidadesnuevasdifarlib.xlsx")
# AQUI MANUALMENTE SE DEBE PREGUNTAR AL SEÑOR RICARDO A QUE ZONAS PERTENECEN ESAS NUEVAS LOCALIDADES, UNA VEZ AGREGADAS
# EN EL EXCEL DE LOCALIDADES DIMEXA YA SE DEBE REGRESAR A R Y CORRER ESTA VEZ EL PROGRAMA COMPLETO
data_maestro_localidades<-merge(x = data_maestro, y=localidadesdifarlib, by.x = "COMBINACION", all.x = TRUE)
data_maestro_localidades<-data_maestro_localidades %>%
select(FUENTE,periodo,NUMERO,FECHA,`RUC/DNI`,ELIMINAR,`NOMBRE COMERCIAL`,TIPO,ARTDES,artdesvalid,CANT.,
VALOR,DSCVEND,ZONA,VENDEDOR,tipo,equipo,ppuni,ppsol,flag,DEPARTAMENTO,DISTRITO...24,PROVINCIA...23)
write_xlsx(data_maestro_localidades,"difarlib.xlsx")
# limpiando nuestra ventana
rm(list=ls())
library(RSelenium)
library(rvest)
library(tidyverse)
library(lubridate)
library(dplyr)
library(writexl)
library(readxl)
library(RODBC)
#--------------------------------------------------------------------------------------------------------#
#--------------------------------------------------------------------------------------------------------#
# --- FORMATEO DE DATA - FORMATEO DE DATA - FORMATEO DE DATA - FORMATEO DE DATA - FORMATEO DE DATA ----- #
#--------------------------------------------------------------------------------------------------------#
#--------------------------------------------------------------------------------------------------------#
# son 4 los departamentos que se descarga la data en dimexa
detalle <- read_xlsx("C:\\Users\\LBarrios\\Downloads\\detalle.xlsx")
detalle1 <- read_xlsx("C:\\Users\\LBarrios\\Downloads\\detalle (1).xlsx")
detalle2 <- read_xlsx("C:\\Users\\LBarrios\\Downloads\\detalle (2).xlsx")
detalle3 <- read_xlsx("C:\\Users\\LBarrios\\Downloads\\detalle (3).xlsx")
# combinando los 4 departamentos descargados de dimexa
data<-rbind(detalle,detalle1,detalle2,detalle3)
rm(detalle,detalle1,detalle2,detalle3)
# cambiando el formato de la fecha
data$FECHA<-paste0(ifelse(day(data$FECHA)<10,paste0(0,day(data$FECHA)),day(data$FECHA)),
"/",
ifelse(month(data$FECHA)<10,paste0(0,month(data$FECHA)),month(data$FECHA))  ,
"/",
year(data$FECHA))
# creando columna fuente que diga METRONIC
data<-data %>% mutate(FUENTE="DIMEXA")
# creando columna periodo con el primer dia del mes a actualizar
data<-data %>% mutate(periodo=paste0("01/",
ifelse(month(today())<10,paste0("0",month(today())),month(today())),
"/",
year(today())))
# insertando columna ELIMINAR en vacio
data<-data %>% mutate(ELIMINAR="")
# creando columna DSCZONA
data<-data %>% mutate(DSCVEND="")
# creando ppuni ppsol flag dpto dist prov que estaran vacias
data<-data %>% mutate(ppuni="") %>% mutate(ppsol="") %>% mutate(flag="")
# seleccionando solo las columnas que nos interesan
# DATA2 TIENE EL FORMATO QUE SE CARGARIA AL SQL
# AQUI NO ESTOY PONIENDO ZONA NI DSCVEND NI TIPO NI EQUIPO
# NI ARTDESVALID PORQUE ESOS SERAN LOS QUE TRAERÉ CON EL MERGE
data2<-data %>%
select(FUENTE,periodo,`NUMERO FACTURA`,FECHA,`RUC CLIENTE`,ELIMINAR,
`NOMBRE CLIENTE`,`TIPO DOCUMENTO`,`NOMBRE PRODUCTO`,
CANTIDAD,`SUB TOTAL`,`NOMBRE VENDEDOR`,ppuni,ppsol,flag,DEPARTAMENTO,DISTRITO,PROVINCIA)
# marcar una E en eliminar cuando el nombre del vendedor sea BRUNY CHAVEZ SALAS o MERCEDES COTRINA VERGEL
# primero identificamos la posicion de las filas donde esta bruny y mercedes
BRUNYNROW<-which(data2$`NOMBRE VENDEDOR` == "BRUNY CHAVEZ SALAS", arr.ind=TRUE)
MERCEDESNROW<-which(data2$`NOMBRE VENDEDOR` == "MERCEDES COTRINA VERGEL", arr.ind=TRUE)
# ahora le decimos que para esas filas ponga una E en la columna Eliminar
data2$ELIMINAR[BRUNYNROW]="E"
data2$ELIMINAR[MERCEDESNROW]="E"
# data$ELIMINAR[BRUNYNROW]
# write_xlsx(data,"dimexa.xlsx")
# LEYENDO DATA NECESARIA PARA VALIDAR
maestrolansier <- read_xlsx("maestrolansier.xlsx")
# selecciono solo lo que voy a querer de maestro lansier que para este caso seria DIMEXA artdesvalid tipo y equipo
df2<-maestrolansier %>% select(DIMEXA,`artdsc VALID`,TIPO,equipo)
# cambio el nombre a df2 para que coincida el nombre de la columna articulo para poder hacer el merge
colnames(df2)<-c("NOMBRE PRODUCTO","artdesvalid","tipo","equipo")
# CON ESTO QUITO LOS ESPACIOS AL COMIENZO Y EL FINAL DE LOS ARTICULOS PORQUE NO PERMITIAN CRUZAR TODO
data2$`NOMBRE PRODUCTO`<-trimws(data2$`NOMBRE PRODUCTO`,"b")
df2$`NOMBRE PRODUCTO`<-trimws(df2$`NOMBRE PRODUCTO`,"b")
df2$artdesvalid<-trimws(df2$artdesvalid,"b")
# EL SIGUIENTE PASO ES OPCIONAL, PORQUE IGUAL EN EL MERGE SIGUIENTE NO SE TOMARÁ EN CUENTA LOS PRODUCTOS QUE NO SE CRUCEN
# antes de cruzar debemos validar que esten los mismo productos y cuales no reconoce
productosnuevosdimexa<-data2[!data2$`NOMBRE PRODUCTO` %in% df2$`NOMBRE PRODUCTO`,]
View(productosnuevosdimexa)
write_xlsx(productosnuevosdimexa,"productosnuevosdimexa.xlsx")
# ----------------------------------------------------- #
# ---CRUCE DE INFORMACIÓN PARA OBTENER LOS VALIDADOS--- #
# ----------------------------------------------------- #
# cruzando para obtener los validados, tipo y equipo
# ArtdesValid2<-merge(x = data2, y = df2, by.x = "NOMBRE PRODUCTO", all.x = TRUE)
# utilizamos con all.x = false porque de ese modo no trae las toallitas humedas ni alcohol en gel, dado que no
# son productos de lansier
data_maestro<-merge(x = data2, y = df2, by.x = "NOMBRE PRODUCTO", all.x = FALSE)
# ----------------------------------------------------- #
# ---CRUCE DE INFORMACIÓN PARA OBTENER LOS VALIDADOS--- #
# ----------------------------------------------------- #
# cruzando para obtener los validados, tipo y equipo
# ArtdesValid2<-merge(x = data2, y = df2, by.x = "NOMBRE PRODUCTO", all.x = TRUE)
# utilizamos con all.x = false porque de ese modo no trae las toallitas humedas ni alcohol en gel, dado que no
# son productos de lansier
data_maestro<-merge(x = data2, y = df2, by.x = "NOMBRE PRODUCTO", all.x = TRUE)
# ----------------------------------------------------- #
# ---CRUCE DE INFORMACIÓN PARA OBTENER LOS VALIDADOS--- #
# ----------------------------------------------------- #
# cruzando para obtener los validados, tipo y equipo
# ArtdesValid2<-merge(x = data2, y = df2, by.x = "NOMBRE PRODUCTO", all.x = TRUE)
# utilizamos con all.x = false porque de ese modo no trae las toallitas humedas ni alcohol en gel, dado que no
# son productos de lansier
data_maestro<-merge(x = data2, y = df2, by.x = "NOMBRE PRODUCTO", all.x = FALSE)
# ----------------------------------------------------- #
# ---CRUCE DE INFORMACIÓN PARA OBTENER LOS VALIDADOS--- #
# ----------------------------------------------------- #
# cruzando para obtener los validados, tipo y equipo
# ArtdesValid2<-merge(x = data2, y = df2, by.x = "NOMBRE PRODUCTO", all.x = TRUE)
# utilizamos con all.x = false porque de ese modo no trae las toallitas humedas ni alcohol en gel, dado que no
# son productos de lansier
data_maestro<-merge(x = data2, y = df2, by.x = "NOMBRE PRODUCTO", all.x = FALSE)
# CRUZANDO PARA OBTENER LA LOCALIDAD
# 1. concatenamos departamento + distrito de nuestra data_maestro para generar la llave
data_maestro<-data_maestro %>% mutate(LLAVE=paste0(DEPARTAMENTO,DISTRITO))
# TRAEMOS LA DATA DE LOCALIDADESDIMEXA
localidadesdimexa <- read_xlsx("localidadesdimexa.xlsx")
localidadesdimexa<-localidadesdimexa %>% select(LLAVE,ZONA)
localidadesdimexa$LLAVE<-trimws(localidadesdimexa$LLAVE,"b")
localidadesdimexa$ZONA<-trimws(localidadesdimexa$ZONA,"b")
data_maestro$LLAVE<-trimws(data_maestro$LLAVE,"b")
# VALIDANDO QUE HAYA LAS MISMAS LOCALIDADES TANTO EN NUESTRO EXCEL DESCARGADO COMO EN EL MAESTRO DE LOCALIDADES,
# SI NO ESTAN DEBERÁN AGREGARSE PARA QUE PUEDAN CRUZARSE CORRECTAMENTE LUEGO.
localidadesnuevasdimexa<-data_maestro[!data_maestro$LLAVE %in% localidadesdimexa$LLAVE,]
View(localidadesnuevasdimexa)
write_xlsx(localidadesnuevasdimexa,"localidadesnuevasdimexa.xlsx")
# CRUZANDO PARA OBTENER LA LOCALIDAD
# 1. concatenamos departamento + distrito de nuestra data_maestro para generar la llave
data_maestro<-data_maestro %>% mutate(LLAVE=paste0(DEPARTAMENTO,DISTRITO))
# TRAEMOS LA DATA DE LOCALIDADESDIMEXA
localidadesdimexa <- read_xlsx("localidadesdimexa.xlsx")
localidadesdimexa<-localidadesdimexa %>% select(LLAVE,ZONA)
localidadesdimexa$LLAVE<-trimws(localidadesdimexa$LLAVE,"b")
localidadesdimexa$ZONA<-trimws(localidadesdimexa$ZONA,"b")
data_maestro$LLAVE<-trimws(data_maestro$LLAVE,"b")
# VALIDANDO QUE HAYA LAS MISMAS LOCALIDADES TANTO EN NUESTRO EXCEL DESCARGADO COMO EN EL MAESTRO DE LOCALIDADES,
# SI NO ESTAN DEBERÁN AGREGARSE PARA QUE PUEDAN CRUZARSE CORRECTAMENTE LUEGO.
localidadesnuevasdimexa<-data_maestro[!data_maestro$LLAVE %in% localidadesdimexa$LLAVE,]
write_xlsx(localidadesnuevasdimexa,"localidadesnuevasdimexa.xlsx")
data_maestro_localidades<-merge(x = data_maestro, y=localidadesdimexa, by.x = "LLAVE", all.x = TRUE)
# TRAEMOS LA DATA DE VENDEDORES PARA CRUZARLA MEDIANTE EL RUC
vendedoresdimexa<-read_xlsx("vendedoresdimexa.xlsx")
vendedoresdimexa<-vendedoresdimexa %>% select(ruc,flag)
colnames(vendedoresdimexa)<-c("RUC CLIENTE","DSCVEND")
# quitando los espacios en blanco delante y detrás
data_maestro_localidades$`RUC CLIENTE`<-trimws(data_maestro_localidades$`RUC CLIENTE`,"b")
vendedoresdimexa$`RUC CLIENTE`<-trimws(vendedoresdimexa$`RUC CLIENTE`,"b")
# combinando y validando con la data de vendedoresdimexa para traer el dscvend o flag como está en vendedoresdimexa
dimexa<-merge(data_maestro_localidades,vendedoresdimexa,by.x = "RUC CLIENTE",all.x = TRUE)
# dandole orden a nuestro excel
dimexa<-dimexa %>%
select(FUENTE,periodo,`NUMERO FACTURA`,FECHA,`RUC CLIENTE`,ELIMINAR,
`NOMBRE CLIENTE`,`TIPO DOCUMENTO`,`NOMBRE PRODUCTO`,artdesvalid,
CANTIDAD,`SUB TOTAL`,DSCVEND,ZONA,`NOMBRE VENDEDOR`,tipo,equipo,ppuni,ppsol,flag,DEPARTAMENTO,DISTRITO,PROVINCIA)
# generando el xlsx con la data para subir al visor o sql
write_xlsx(dimexa,"dimexa.xlsx")
# limpiando nuestra ventana
rm(list=ls())
# y al excel que nos da ponerle de nombre b2binretail
library(readxl)
library(dplyr)
library(lubridate)
library(readr)
library(RODBC)
#--------------------
# ------------ con trimws puedo quitar los espacios iniciales y finales de un texto --------- #
# x<- "  texto con espacios "
# trimws(x,"b")
#--------------------
data<-read.csv(file = "C:/Users/LBarrios/Downloads/b2binretail.csv")
#-------------------------------------------- para un dia normal --------------------------------------------#
data<-data %>% mutate(fecha_update=(as.Date(paste0(ifelse(day(today())-1<10,paste0("0",day(today())-1),day(today())-1),
"/",
month(today()),
"/",
year(today())),"%d/%m/%Y")))
data<-data %>% mutate(periodo=as.Date( paste0("01","/",month(today()),"/",year(today())),"%d/%m/%Y")) #esta fecha esta para el mes actual, si se desea algun mes en especial se debe cambiar
# DESCRIPCION
# INVENTARIO.u.
# INVENTARIO.S.
# -----------formato ventas-----------
# periodo
# fecha_update
# DESCRIPCION
# COD_LOCAL
# VTA_PERIODO_UNID
# VALOR_VTA_PUB_PERIODO_S
stock<-data %>% select(fecha_update,COD_LOCAL,DESCRIPCION,INVENTARIO.u.,INVENTARIO.S.)
venta<-data %>% select(periodo,fecha_update,DESCRIPCION,COD_LOCAL,VTA_PERIODO_UNID,VALOR_VTA_PUB_PERIODO_S)
# write_tsv(venta, file = "ventab2b.txt",na = " ")
# rm(list=ls())
#---------------------------------------------------------------------#
#                subiendo la data directamente al SQL                 #
#---------------------------------------------------------------------#
# para esta ocasion se creó una conexión ODBC or somethin like that para poder conectarnos a la
# base de datos de Inretail, porque SQLuis era para la base de datos BI_Comercial
# si logro realizar este paso ya no deberia generar los txt de stock y venta :D
sqlb2b<-odbcConnect("SQLb2b",uid = "sa",pwd = "Comercial.2020")
# BORRANDO EL STOCKB2B Y EL MES ACTUAL DE VENTASB2B EN EL SQL
# para stock
sqlQuery(sqlb2b,"delete from StockInretail")
# para dia normal usar este codigo
sqlQuery(sqlb2b, paste0("delete from VentaInretail where periodo='01/",
ifelse(month(today())<10,paste0(0,month(today())),month(today())) ,
"/",year(today()),"'"))
# SUBIENDO EL STOCK AL SQL
sqlSave(sqlb2b,stock,tablename = "StockInretail",rownames = FALSE,append = TRUE,fast = FALSE)
400+170+48*350
48*350
48*350+148*4
